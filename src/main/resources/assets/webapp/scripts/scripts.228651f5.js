"use strict";angular.module("bookstoreWebapp",["ngAnimate","ngCookies","ngSanitize","ngTouch","ngRoute","ngResource","ngTable","ngStorage","ui.bootstrap","toaster"]).constant("API_URL","/api").factory("NgTableParams",["ngTableParams",function(a){return a}]).run(["$localStorage",function(a){void 0===a.cart&&(a.cart={})}]).service("CartService",["$localStorage",function(a){this.addLine=function(b,c){a.cart[b.isbn13]||(a.cart[b.isbn13]={quantity:0,book:b}),a.cart[b.isbn13].quantity+=c},this.getCart=function(){return a.cart},this.totalPrice=function(){var b=0;return angular.forEach(a.cart,function(a){b+=parseFloat(a.book.unitPrice)*parseInt(a.quantity)}),b},this.totalBooks=function(){var b=0;return angular.forEach(a.cart,function(a){b+=parseInt(a.quantity)}),b},this.removeLine=function(b){delete a.cart[b.book.isbn13]}}]).factory("httpRequestInterceptor",["SessionService","$q","toaster","$location",function(a,b,c,d){var e={request:function(b){return a.isAnonymous()||(b.headers.Authorization="Bearer "+a.getToken()),b},responseError:function(e){return 401===e.status&&"/login"!==d.path()&&(c.pop("error","Error occurred",e.data,5e3),a.logout(),d.path("/login")),b.reject(e)}};return e}]).service("SessionService",["$cookieStore","$localStorage",function(a,b){var c=null,d=null,e=null;a.get("login")&&(c=a.get("login")),this.isAnonymous=function(){return!c},this.login=function(b,d,f){f&&a.put("login",b),c=b,e=d},this.logout=function(){a.put("login",null),b.cart={},c=null},this.getToken=function(){return c},this.getLogin=function(){return e},this.needAuthentification=function(a){d=a},this.comeFromPrivatePage=function(){return d}}]).controller("PageCtrl",["$scope","$location","$http","SessionService","CartService",function(a,b,c,d,e){a.loggedIn=!1,a.isActive=function(a){return a===b.path()},a.loggedIn=function(){return!d.isAnonymous()},a.logout=function(){d.logout()},a.cartTotalPrice=function(){return e.totalPrice()},a.cartTotalBooks=function(){return e.totalBooks()},a.$watch("$viewContentLoaded",function(){a.pageLoaded=!0})}]).provider("SecureService",function(){this.filter=function(a,b,c,d,e){if(a.isAnonymous()===!1){var f=b.defer();return f.resolve(),f.promise}d.pop("warning","Authentification","You need to be authenticated to access to the page "+e,0),a.needAuthentification(e),c.path("/login")},this.$get=function(){}}).config(["$routeProvider","$locationProvider","$httpProvider","SecureServiceProvider",function(a,b,c,d){b.hashPrefix("!"),c.interceptors.push("httpRequestInterceptor"),a.when("/",{controller:"MainCtrl",templateUrl:"../views/main.html"}).when("/books",{controller:"BookCtrl",templateUrl:"../views/book.html",resolve:{load:["SessionService","$q","$location","toaster",function(a,b,c,e){d.filter(a,b,c,e,"/books")}]}}).when("/profile",{controller:"ProfileCtrl",templateUrl:"../views/profile.html",resolve:{load:["SessionService","$q","$location","toaster",function(a,b,c,e){d.filter(a,b,c,e,"/profile")}]}}).when("/orders",{controller:"OrdersCtrl",templateUrl:"../views/orders.html",resolve:{load:["SessionService","$q","$location","toaster",function(a,b,c,e){d.filter(a,b,c,e,"/orders")}]}}).when("/cart",{controller:"CartCtrl",templateUrl:"../views/cart.html",resolve:{load:["SessionService","$q","$location","toaster",function(a,b,c,e){d.filter(a,b,c,e,"/cart")}]}}).when("/login",{controller:"AuthCtrl",templateUrl:"../views/login.html"}).when("/register",{controller:"RegisterCtrl",templateUrl:"../views/register.html"}).otherwise({redirectTo:"/"})}]),angular.module("bookstoreWebapp").controller("MainCtrl",["$scope",function(a){a.technologiesFront=["HTML5 Boilerplate","AngularJS","Karma","CSS 3","Bootstrap","ng-table","toaster"],a.technologiesBack=["Jersey","JPA","Hibernate","Jackson","Jetty","Guice","Dropwizard"]}]),angular.module("bookstoreWebapp").controller("BookCtrl",["$scope","BookFactory","AuthorFactory","NgTableParams","$filter","$modal","$http",function(a,b,c,d,e,f,g){var h=b.query();a.criterias={},a.userCriterias={},a.processNewBooks=function(b){angular.forEach(b,function(a){a.author=c.get({authorId:a.authorId}),a.author.$promise.then(function(b){a.author.fullName=b.lastName+" "+b.firstName})}),a.tableParams.reload()},h.$promise.then(function(b){a.processNewBooks(b)}),a.openDetails=function(a,b){f.open({templateUrl:"modalBookDetails.html",controller:"DetailsBookCtrl",size:b,resolve:{book:function(){return a}}})},a.addCriteria=function(b,c){a.userCriterias[b]=c,a.searchCriteria()},a.removeCriteria=function(b){delete a.userCriterias[b],a.searchCriteria()},a.searchCriteria=function(){g.post("/api/book/byCriterias",a.userCriterias).success(function(b){a.processNewBooks(b),a.books=b}).error(function(){})},g.get("/api/book/criterias").success(function(b){a.criterias=b}),a.isAnyUserCriterias=function(){return!angular.equals({},a.userCriterias)},a.tableParams=new d({page:1,count:5,filterDelay:0,filter:{isbn13:""},sorting:{isbn13:"asc"}},{total:h.length,filterDelay:300,getData:function(b,c){var d=c.filter()?e("filter")(h,c.filter()):h;d=c.sorting()?e("orderBy")(d,c.orderBy()):d,a.tableParams.operatorPrice&&a.tableParams.limitPrice&&(d=e("price")(d,a.tableParams.operatorPrice,a.tableParams.limitPrice)),a.books=d.slice((c.page()-1)*c.count(),c.page()*c.count()),c.total(d.length),b.resolve(a.books)}}),a.reassessUnitPriceFilter=function(){a.tableParams.reload()},a.tableParams.operatorPrice="",a.tableParams.limitPrice=30}]).controller("DetailsBookCtrl",["$scope","$modalInstance","book","CartService",function(a,b,c,d){a.book=c,a.cancel=function(){b.dismiss("cancel")},a.addToCart=function(a){d.addLine(c,a),b.dismiss("cancel")}}]).filter("price",function(){return function(a,b,c){var d=[];return angular.forEach(a,function(a){">"===b&&a.unitPrice>c?d.push(a):"<"===b&&a.unitPrice<c?d.push(a):"="===b&&a.unitPrice===Number(c)&&d.push(a)}),d}}),angular.module("bookstoreWebapp").controller("AuthCtrl",["$scope","$http","SessionService","$location","$timeout","toaster",function(a,b,c,d,e,f){a.username="",a.password="",a.login=function(){b.post("/api/user/authenticate","username="+a.username+"&password="+a.password,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b){f.pop("success","Logged","Welcome "+a.username,5e3),c.login(b,a.username,!0),d.path(c.comeFromPrivatePage()?c.comeFromPrivatePage():"/")}).error(function(a,b){switch(b){case 401:f.pop("error","Error","Your username/password are not correct. Please verify it and try again.",15e3);break;default:f.pop("error","Error","An error occurred during the authentification. Please try again.",15e3)}})}}]),angular.module("bookstoreWebapp").controller("RegisterCtrl",["$scope","$http","toaster","$location",function(a,b,c,d){a.username="",a.password="",a.email="",a.emailRepeat="",a.passwordRepeat="",a.isErrorMailRepeat=!1,a.isErrorPwdRepeat=!1,a.register=function(){b.post("/api/user/",{login:a.username,password:a.password,email:a.email}).success(function(){c.pop("success","Registered","You have been registered successfully with the username "+a.username,15e3),d.path("/login")}).error(function(a){if(a.errors){var b="<ul>";angular.forEach(a.errors,function(a){b+="<li>"+a+"</li>"},b),b+="</ul>",c.pop("error","Error","Error(s) occurred during the registration : "+b,0,"trustedHtml")}})},a.checkEmail=function(){a.isErrorMailRepeat=a.emailRepeat!==a.email},a.checkPassword=function(){a.isErrorPwdRepeat=a.passwordRepeat!==a.password}}]),angular.module("bookstoreWebapp").controller("ProfileCtrl",["$scope","$http","toaster",function(a,b,c){a.oldPassword="",a.newPassword="",a.newPasswordRepeat="",b.get("/api/user/me").success(function(c){a.profile=c,a.profile.address={},c.mailingAddressId&&b.get("/api/mailingAddress/"+c.mailingAddressId).success(function(b){a.profile.address=b})}),a.updateEmail=function(){b.put("/api/user/updateEmail",a.profile.email).success(function(){c.pop("success","Email has been updated","Your email has been updated.",5e3,"trustedHtml")})},a.updatePassword=function(){b.put("/api/user/updatePassword",a.newPassword).success(function(){c.pop("success","Password has been updated","Your password has been updated.",5e3,"trustedHtml")})},a.updateAddress=function(){b.put("/api/mailingAddress",a.profile.address).success(function(){c.pop("success","Address updated","Your address has been updated.",5e3,"trustedHtml")}).error(function(a){if(a.errors){var b="<ul>";angular.forEach(a.errors,function(a){b+="<li>"+a+"</li>"},b),b+="</ul>",c.pop("error","Error","Error(s) occurred during the registration : "+b,0,"trustedHtml")}})},a.checkPassword=function(){a.isErrorPwdRepeat=a.newPasswordRepeat!==a.newPassword},a.checkOldPassword=function(){a.isErrorOldPwd=a.profile.password!==a.oldPassword}}]),angular.module("bookstoreWebapp").controller("OrdersCtrl",["$scope","$http",function(a,b){b.get("/api/order/mine").success(function(c){a.orders=c,angular.forEach(c,function(a){a.mailingAddressId&&b.get("/api/mailingAddress/"+a.mailingAddressId).success(function(b){a.address=b}),a.total=0,a.articles=0,b.get("/api/orderLine/byOrder/"+a.id).success(function(c){a.lines=c,angular.forEach(c,function(c){b.get("/api/book/"+c.bookIsbn13).success(function(d){a.total+=parseFloat(d.unitPrice)*parseInt(c.quantity),a.articles+=parseInt(c.quantity),c.book=d,d.authorId&&b.get("/api/author/"+d.authorId).success(function(a){d.author=a})})})})})})}]),angular.module("bookstoreWebapp").controller("CartCtrl",["$scope","$localStorage","$http","CartService","$modal",function(a,b,c,d,e){a.cart=b.cart,a.cartTotalPrice=function(){return d.totalPrice()},a.cartTotalBooks=function(){return d.totalBooks()},a.removeLine=function(a){d.removeLine(a)},a.processOrder=function(a){e.open({templateUrl:"modalProcessOrder.html",controller:"ProcessOrderCtrl",size:"lg",resolve:{totalPrice:function(){return a}}})}}]).controller("ProcessOrderCtrl",["$scope","$localStorage","$modalInstance","$http","totalPrice","toaster","$location",function(a,b,c,d,e,f,g){a.totalPrice=e,a.cart=b.cart,a.savedProfileAddress={},d.get("/api/user/me").success(function(b){a.profile=b,a.profile.address={},b.mailingAddressId&&d.get("/api/mailingAddress/"+b.mailingAddressId).success(function(b){b.id=0,a.profile.address=b,angular.copy(a.profile.address,a.savedProfileAddress)})}),a.cancel=function(){c.dismiss("cancel")},a.useProfileAddress=function(b){if(b){var c={};angular.copy(a.savedProfileAddress,c),a.profile.address=c}else a.profile.address={}},a.processOrder=function(){var e=[];angular.forEach(b.cart,function(a){e.push({bookIsbn13:a.book.isbn13,quantity:a.quantity})}),d.post("/api/order",{address:a.profile.address,orderLines:e}).success(function(){f.pop("success","Success","Order has been successfully processed.",5e3,"trustedHtml"),b.cart={},c.dismiss("cancel"),g.path("/orders")}).error(function(a){if(a.errors){var b="<ul>";angular.forEach(a.errors,function(a){b+="<li>"+a+"</li>"},b),b+="</ul>",f.pop("error","Error","Error(s) occurred during the order process : "+b,0,"trustedHtml")}})}}]),angular.module("bookstoreWebapp").factory("BookFactory",["$resource","API_URL",function(a,b){return a(b+"/book/:bookId",{bookId:"@_id"})}]),angular.module("bookstoreWebapp").factory("AuthorFactory",["$resource","API_URL",function(a,b){return a(b+"/author/:authorId",{authorId:"@_id"})}]);