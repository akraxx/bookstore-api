"use strict";angular.module("bookstoreWebapp",["ngAnimate","ngCookies","ngSanitize","ngTouch","ngRoute","ngResource","ngTable","ui.bootstrap","toaster"]).constant("API_URL","/api").factory("NgTableParams",["ngTableParams",function(a){return a}]).factory("httpRequestInterceptor",["SessionService",function(a){var b={request:function(b){return a.isAnonymous()||(b.headers.Authorization="Bearer "+a.getToken()),b}};return b}]).service("SessionService",["$cookieStore",function(a){var b=null,c=null;a.get("login")&&(b=a.get("login")),this.isAnonymous=function(){return!b},this.login=function(c,d){d&&a.put("login",c),b=c},this.logout=function(){a.put("login",null),b=null},this.getToken=function(){return b},this.needAuthentification=function(a){c=a},this.comeFromPrivatePage=function(){return c}}]).controller("PageCtrl",["$scope","$location","$http","SessionService",function(a,b,c,d){a.loggedIn=!1,a.isActive=function(a){return a===b.path()},a.loggedIn=function(){return!d.isAnonymous()},a.logout=function(){d.logout()},a.$watch("$viewContentLoaded",function(){a.pageLoaded=!0})}]).provider("FooService",function(){this.filter=function(a,b,c,d,e){if(a.isAnonymous()===!1){var f=b.defer();return f.resolve(),f.promise}d.pop("warning","Authentification","You need to be authenticated to access to the page "+e,0),a.needAuthentification(e),c.path("/login")},this.$get=function(){}}).config(["$routeProvider","$locationProvider","$httpProvider","FooServiceProvider",function(a,b,c,d){b.hashPrefix("!"),c.interceptors.push("httpRequestInterceptor"),a.when("/",{controller:"MainCtrl",templateUrl:"../views/main.html"}).when("/books",{controller:"BookCtrl",templateUrl:"../views/book.html",resolve:{load:["SessionService","$q","$location","toaster",function(a,b,c,e){d.filter(a,b,c,e,"/books")}]}}).when("/login",{controller:"AuthCtrl",templateUrl:"../views/login.html"}).when("/register",{controller:"RegisterCtrl",templateUrl:"../views/register.html"}).otherwise({redirectTo:"/"})}]),angular.module("bookstoreWebapp").controller("MainCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("bookstoreWebapp").controller("BookCtrl",["$scope","BookFactory","AuthorFactory","NgTableParams","$filter","$modal",function(a,b,c,d,e,f){var g=b.query();g.$promise.then(function(a){angular.forEach(a,function(a){a.author=c.get({authorId:a.authorId})})}),a.openDetails=function(a,b){f.open({templateUrl:"modalBookDetails.html",controller:"DetailsBookCtrl",size:b,resolve:{book:function(){return a}}})},a.tableParams=new d({page:1,count:5,filter:{isbn13:""}},{total:g.length,getData:function(b,c){var d=c.filter()?e("filter")(g,c.filter()):g;d=c.sorting()?e("orderBy")(d,c.orderBy()):d,a.books=d.slice((c.page()-1)*c.count(),c.page()*c.count()),c.total(d.length),b.resolve(a.books)}})}]).controller("DetailsBookCtrl",["$scope","$modalInstance","book",function(a,b,c){a.book=c,a.cancel=function(){b.dismiss("cancel")}}]),angular.module("bookstoreWebapp").controller("AuthCtrl",["$scope","$http","SessionService","$location","$timeout","toaster",function(a,b,c,d,e,f){a.username="",a.password="",a.login=function(){b.post("/api/user/authenticate","username="+a.username+"&password="+a.password,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b){f.pop("success","Logged","Welcome "+a.username,5e3),c.login(b,!0),d.path(c.comeFromPrivatePage()?c.comeFromPrivatePage():"/")}).error(function(a,b){switch(b){case 401:f.pop("error","Error","Your username/password are not correct. Please verify it and try again.",15e3);break;default:f.pop("error","Error","An error occurred during the authentification. Please try again.",15e3)}})}}]),angular.module("bookstoreWebapp").controller("RegisterCtrl",["$scope","$http","toaster","$location",function(a,b,c,d){a.username="",a.password="",a.email="",a.emailRepeat="",a.isErrorMailRepeat=!1,a.errorMailRepeat="E-Mails are not equals.",a.register=function(){b.post("/api/user/",{login:a.username,password:a.password,email:a.email}).success(function(){c.pop("success","Registered","You have been registered successfully with the username "+a.username,15e3),d.path("/login")}).error(function(a){if(a.errors){var b="<ul>";angular.forEach(a.errors,function(a){b+="<li>"+a+"</li>"},b),b+="</ul>",c.pop("error","Error","Error(s) occurred during the registration : "+b,0,"trustedHtml")}})},a.checkEmail=function(){a.isErrorMailRepeat=a.emailRepeat!==a.email}}]),angular.module("bookstoreWebapp").factory("BookFactory",["$resource","API_URL",function(a,b){return a(b+"/book/:bookId",{bookId:"@_id"})}]),angular.module("bookstoreWebapp").factory("AuthorFactory",["$resource","API_URL",function(a,b){return a(b+"/author/:authorId",{authorId:"@_id"})}]);